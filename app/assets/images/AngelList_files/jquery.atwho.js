/*! jquery.atwho - v0.4.12 - 2014-06-26
* Copyright (c) 2014 chord.luo <chord.luo@gmail.com>; 
* homepage: http://ichord.github.com/At.js 
* Licensed MIT
*/
(function(){!function(t){return"function"==typeof define&&define.amd?define(["jquery"],t):t(window.jQuery)}(function(t){var e,i,n,r,o,a,s,l,c,u=[].slice;n=function(){function e(e){this.current_flag=null,this.controllers={},this.alias_maps={},this.$inputor=t(e),this.iframe=null,this.setIframe(),this.listen()}return e.prototype.setIframe=function(t){var e;if(t)return this.window=t.contentWindow,this.document=t.contentDocument||this.window.document,this.iframe=t,this;this.document=this.$inputor[0].ownerDocument,this.window=this.document.defaultView||this.document.parentWindow;try{return this.iframe=this.window.frameElement}catch(i){e=i}},e.prototype.controller=function(t){var e,i,n,r;if(this.alias_maps[t])i=this.controllers[this.alias_maps[t]];else{r=this.controllers;for(n in r)if(e=r[n],n===t){i=e;break}}return i?i:this.controllers[this.current_flag]},e.prototype.set_context_for=function(t){return this.current_flag=t,this},e.prototype.reg=function(t,e){var i,n;return i=(n=this.controllers)[t]||(n[t]=new o(this,t)),e.alias&&(this.alias_maps[e.alias]=t),i.init(e),this},e.prototype.listen=function(){return this.$inputor.on("keyup.atwhoInner",function(t){return function(e){return t.on_keyup(e)}}(this)).on("keydown.atwhoInner",function(t){return function(e){return t.on_keydown(e)}}(this)).on("scroll.atwhoInner",function(t){return function(e){var i;return null!=(i=t.controller())?i.view.hide(e):void 0}}(this)).on("blur.atwhoInner",function(t){return function(e){var i;return(i=t.controller())?i.view.hide(e,i.get_opt("display_timeout")):void 0}}(this))},e.prototype.shutdown=function(){var t,e,i;i=this.controllers;for(e in i)t=i[e],t.destroy(),delete this.controllers[e];return this.$inputor.off(".atwhoInner")},e.prototype.dispatch=function(){return t.map(this.controllers,function(t){return function(e){var i;return(i=e.get_opt("delay"))?(clearTimeout(t.delayedCallback),t.delayedCallback=setTimeout(function(){return e.look_up()?t.set_context_for(e.at):void 0},i)):e.look_up()?t.set_context_for(e.at):void 0}}(this))},e.prototype.on_keyup=function(e){var i;switch(e.keyCode){case s.ESC:e.preventDefault(),null!=(i=this.controller())&&i.view.hide();break;case s.DOWN:case s.UP:case s.CTRL:t.noop();break;case s.P:case s.N:e.ctrlKey||this.dispatch();break;default:this.dispatch()}},e.prototype.on_keydown=function(e){var i,n;if(i=null!=(n=this.controller())?n.view:void 0,i&&i.visible())switch(e.keyCode){case s.ESC:e.preventDefault(),i.hide(e);break;case s.UP:e.preventDefault(),i.prev();break;case s.DOWN:e.preventDefault(),i.next();break;case s.P:if(!e.ctrlKey)return;e.preventDefault(),i.prev();break;case s.N:if(!e.ctrlKey)return;e.preventDefault(),i.next();break;case s.TAB:case s.ENTER:if(!i.visible())return;e.preventDefault(),i.choosing=!0,i.choose(e);break;default:t.noop()}},e}(),o=function(){function i(i,n){this.app=i,this.at=n,this.$inputor=this.app.$inputor,this.id=this.$inputor[0].id||this.uid(),this.setting=null,this.query=null,this.pos=0,this.cur_rect=null,this.range=null,e.append(this.$el=t("<div id='atwho-ground-"+this.id+"'></div>")),this.model=new l(this),this.view=new c(this)}return i.prototype.uid=function(){return(Math.random().toString(16)+"000000000").substr(2,8)+(new Date).getTime()},i.prototype.init=function(e){return this.setting=t.extend({},this.setting||t.fn.atwho["default"],e),this.view.init(),this.model.reload(this.setting.data)},i.prototype.destroy=function(){return this.trigger("beforeDestroy"),this.model.destroy(),this.view.destroy(),this.$el.remove()},i.prototype.call_default=function(){var e,i,n;n=arguments[0],e=2<=arguments.length?u.call(arguments,1):[];try{return a[n].apply(this,e)}catch(r){return i=r,t.error(""+i+" Or maybe At.js doesn't have function "+n)}},i.prototype.trigger=function(t,e){var i,n;return null==e&&(e=[]),e.push(this),i=this.get_opt("alias"),n=i?""+t+"-"+i+".atwho":""+t+".atwho",this.$inputor.trigger(n,e)},i.prototype.callbacks=function(t){return this.get_opt("callbacks")[t]||a[t]},i.prototype.get_opt=function(t){var e;try{return this.setting[t]}catch(i){return e=i,null}},i.prototype.content=function(){return this.$inputor.is("textarea, input")?this.$inputor.val():this.$inputor.text()},i.prototype.catch_query=function(){var t,e,i,n,r,o;return e=this.content(),t=this.$inputor.caret("pos"),o=e.slice(0,t),n=this.callbacks("matcher").call(this,this.at,o,this.get_opt("start_with_space")),"string"==typeof n&&n.length<=this.get_opt("max_len",20)?(r=t-n.length,i=r+n.length,this.pos=r,n={text:n,head_pos:r,end_pos:i},this.trigger("matched",[this.at,n.text])):(n=null,this.view.hide()),this.query=n},i.prototype.rect=function(){var t,e;if(t=this.$inputor.caret({iframe:this.app.iframe}).caret("offset",this.pos-1))return"true"===this.$inputor.attr("contentEditable")&&(t=this.cur_rect||(this.cur_rect=t)||t),e=this.app.document.selection?0:2,{left:t.left,top:t.top,bottom:t.top+t.height+e}},i.prototype.reset_rect=function(){return"true"===this.$inputor.attr("contentEditable")?this.cur_rect=null:void 0},i.prototype.mark_range=function(){return"true"===this.$inputor.attr("contentEditable")&&(this.app.window.getSelection&&(this.range=this.app.window.getSelection().getRangeAt(0)),this.app.document.selection)?this.ie8_range=this.app.document.selection.createRange():void 0},i.prototype.insert_content_for=function(e){var i,n,r;return n=e.data("value"),r=this.get_opt("insert_tpl"),this.$inputor.is("textarea, input")||!r?n:(i=t.extend({},e.data("item-data"),{"atwho-data-value":n,"atwho-at":this.at}),this.callbacks("tpl_eval").call(this,r,i))},i.prototype.insert=function(e,i){var n,r,o,a,s,l,c,u,d,h,p;return n=this.$inputor,"true"===n.attr("contentEditable")&&(o="atwho-view-flag atwho-view-flag-"+(this.get_opt("alias")||this.at),a=""+e+"<span contenteditable='false'>&nbsp;<span>",s="<span contenteditable='false' class='"+o+"'>"+a+"</span>",r=t(s,this.app.document).data("atwho-data-item",i.data("item-data")),this.app.document.selection&&(r=t("<span contenteditable='true'></span>",this.app.document).html(r))),n.is("textarea, input")?(e=this.get_opt("space_after")?e+" ":""+e,d=n.val(),h=d.slice(0,Math.max(this.query.head_pos-this.at.length,0)),p=""+h+e+d.slice(this.query.end_pos||0),n.val(p),n.caret("pos",h.length+e.length)):(c=this.range)?(l=c.startOffset-(this.query.end_pos-this.query.head_pos)-this.at.length,c.setStart(c.endContainer,Math.max(l,0)),c.setEnd(c.endContainer,c.endOffset),c.deleteContents(),c.insertNode(r[0]),c.collapse(!1),u=this.app.window.getSelection(),u.removeAllRanges(),u.addRange(c)):(c=this.ie8_range)&&(c.moveStart("character",this.query.end_pos-this.query.head_pos-this.at.length),c.pasteHTML(a),c.collapse(!1),c.select()),n.is(":focus")||n.focus(),n.change()},i.prototype.render_view=function(t){var e;return e=this.get_opt("search_key"),t=this.callbacks("sorter").call(this,this.query.text,t.slice(0,1001),e),this.view.render(t.slice(0,this.get_opt("limit")))},i.prototype.look_up=function(){var e,i;if(e=this.catch_query())return i=function(t){return t&&t.length>0?this.render_view(t):this.view.hide()},this.model.query(e.text,t.proxy(i,this)),e},i}(),l=function(){function e(t){this.context=t,this.at=this.context.at,this.storage=this.context.$inputor}return e.prototype.destroy=function(){return this.storage.data(this.at,null)},e.prototype.saved=function(){return this.fetch()>0},e.prototype.query=function(t,e){var i,n,r;return i=this.fetch(),n=this.context.get_opt("search_key"),i=this.context.callbacks("filter").call(this.context,t,i,n)||[],r=this.context.callbacks("remote_filter"),i.length>0||!r&&0===i.length?e(i):r.call(this.context,t,e)},e.prototype.fetch=function(){return this.storage.data(this.at)||[]},e.prototype.save=function(t){return this.storage.data(this.at,this.context.callbacks("before_save").call(this.context,t||[]))},e.prototype.load=function(t){return!this.saved()&&t?this._load(t):void 0},e.prototype.reload=function(t){return this._load(t)},e.prototype._load=function(e){return"string"==typeof e?t.ajax(e,{dataType:"json"}).done(function(t){return function(e){return t.save(e)}}(this)):this.save(e)},e}(),c=function(){function e(e){this.context=e,this.$el=t("<div class='atwho-view'><ul class='atwho-view-ul'></ul></div>"),this.timeout_id=null,this.context.$el.append(this.$el),this.bind_event()}return e.prototype.init=function(){var t;return t=this.context.get_opt("alias")||this.context.at.charCodeAt(0),this.$el.attr({id:"at-view-"+t})},e.prototype.destroy=function(){return this.$el.remove()},e.prototype.bind_event=function(){var e;return e=this.$el.find("ul"),e.on("mouseenter.atwho-view","li",function(i){return e.find(".cur").removeClass("cur"),t(i.currentTarget).addClass("cur")}).on("click",function(t){return function(e){return t.choose(e),e.preventDefault()}}(this))},e.prototype.visible=function(){return this.$el.is(":visible")},e.prototype.choose=function(t){var e,i;return(e=this.$el.find(".cur")).length?(i=this.context.insert_content_for(e),this.context.insert(this.context.callbacks("before_insert").call(this.context,i,e),e),this.context.trigger("inserted",[e,t]),this.hide(t)):void 0},e.prototype.reposition=function(e){var i,n;return e.bottom+this.$el.height()-t(window).scrollTop()>t(window).height()&&(e.bottom=e.top-this.$el.height()),i={left:e.left,top:e.bottom},null!=(n=this.context.callbacks("before_reposition"))&&n.call(this.context,i),this.$el.offset(i),this.context.trigger("reposition",[i])},e.prototype.next=function(){var t,e;return t=this.$el.find(".cur").removeClass("cur"),e=t.next(),e.length||(e=this.$el.find("li:first")),e.addClass("cur")},e.prototype.prev=function(){var t,e;return t=this.$el.find(".cur").removeClass("cur"),e=t.prev(),e.length||(e=this.$el.find("li:last")),e.addClass("cur")},e.prototype.show=function(){var t;return this.choosing?void(this.choosing=!1):(this.context.mark_range(),this.visible()||(this.$el.show(),this.context.trigger("shown")),(t=this.context.rect())?this.reposition(t):void 0)},e.prototype.hide=function(t,e){var i;if(this.visible())return isNaN(e)?(this.context.reset_rect(),this.$el.hide(),this.context.trigger("hidden",[t])):(i=function(t){return function(){return t.hide()}}(this),clearTimeout(this.timeout_id),this.timeout_id=setTimeout(i,e))},e.prototype.render=function(e){var i,n,r,o,a,s,l;if(!(t.isArray(e)&&e.length>0))return void this.hide();for(this.$el.find("ul").empty(),n=this.$el.find("ul"),a=this.context.get_opt("tpl"),s=0,l=e.length;l>s;s++)r=e[s],r=t.extend({},r,{"atwho-at":this.context.at}),o=this.context.callbacks("tpl_eval").call(this.context,a,r),i=t(this.context.callbacks("highlighter").call(this.context,o,this.context.query.text)),i.data("item-data",r),n.append(i);return this.show(),this.context.get_opt("highlight_first")?n.find("li:first").addClass("cur"):void 0},e}(),s={DOWN:40,UP:38,ESC:27,TAB:9,ENTER:13,CTRL:17,P:80,N:78},a={before_save:function(e){var i,n,r,o;if(!t.isArray(e))return e;for(o=[],n=0,r=e.length;r>n;n++)i=e[n],o.push(t.isPlainObject(i)?i:{name:i});return o},matcher:function(t,e,i){var n,r;return t=t.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),i&&(t="(?:^|\\s)"+t),r=new RegExp(t+"([A-Za-z0-9_+-]*)$|"+t+"([^\\x00-\\xff]*)$","gi"),n=r.exec(e),n?n[2]||n[1]:null},filter:function(t,e,i){var n,r,o,a;for(a=[],r=0,o=e.length;o>r;r++)n=e[r],~n[i].toLowerCase().indexOf(t.toLowerCase())&&a.push(n);return a},remote_filter:null,sorter:function(t,e,i){var n,r,o,a;if(!t)return e;for(a=[],r=0,o=e.length;o>r;r++)n=e[r],n.atwho_order=n[i].toLowerCase().indexOf(t.toLowerCase()),n.atwho_order>-1&&a.push(n);return a.sort(function(t,e){return t.atwho_order-e.atwho_order})},tpl_eval:function(t,e){var i;try{return t.replace(/\$\{([^\}]*)\}/g,function(t,i){return e[i]})}catch(n){return i=n,""}},highlighter:function(t,e){var i;return e?(i=new RegExp(">\\s*(\\w*?)("+e.replace("+","\\+")+")(\\w*)\\s*<","ig"),t.replace(i,function(t,e,i,n){return"> "+e+"<strong>"+i+"</strong>"+n+" <"})):t},before_insert:function(t){return t}},i={load:function(t,e){var i;return(i=this.controller(t))?i.model.load(e):void 0},getInsertedItemsWithIDs:function(e){var i,n,r;return(i=this.controller(e))?(e&&(e="-"+(i.get_opt("alias")||i.at)),n=[],r=t.map(this.$inputor.find("span.atwho-view-flag"+(e||"")),function(e){var i;return i=t(e).data("atwho-data-item"),n.indexOf(i.id)>-1?void 0:(i.id&&(n.push=i.id),i)}),[n,r]):[null,null]},getInsertedItems:function(t){return i.getInsertedItemsWithIDs.apply(this,[t])[1]},getInsertedIDs:function(t){return i.getInsertedItemsWithIDs.apply(this,[t])[0]},setIframe:function(t){return this.setIframe(t)},run:function(){return this.dispatch()},destroy:function(){return this.shutdown(),this.$inputor.data("atwho",null)}},r={init:function(e){var i,r;return r=(i=t(this)).data("atwho"),r||i.data("atwho",r=new n(this)),r.reg(e.at,e),this}},e=t("<div id='atwho-container'></div>"),t.fn.atwho=function(n){var o,a;return a=arguments,t("body").append(e),o=null,this.filter("textarea, input, [contenteditable=true]").each(function(){var e;return"object"!=typeof n&&n?i[n]?(e=t(this).data("atwho"))?o=i[n].apply(e,Array.prototype.slice.call(a,1)):void 0:t.error("Method "+n+" does not exist on jQuery.caret"):r.init.apply(this,a)}),o||this},t.fn.atwho["default"]={at:void 0,alias:void 0,space_after:!0,data:null,tpl:"<li data-value='${atwho-at}${name}'>${name}</li>",insert_tpl:"<span>${atwho-data-value}</span>",callbacks:a,search_key:"name",start_with_space:!0,highlight_first:!0,limit:5,max_len:20,display_timeout:300,delay:null}})}).call(this);