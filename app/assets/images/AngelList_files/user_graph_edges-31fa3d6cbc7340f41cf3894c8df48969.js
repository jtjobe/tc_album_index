(function(){var t=function(t,e){return function(){return t.apply(e,arguments)}},e=function(t,e){function i(){this.constructor=t}for(var r in e)n.call(e,r)&&(t[r]=e[r]);return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t},n={}.hasOwnProperty;define(["jquery","lib/template","underscore","lib/dropdown","segment/analytics","lib/flash","lib/transitional_autocomplete","qtip","jquery.magnific"],function(n,i,r,o,a,s,l){var u;return u=r.extend({},Backbone.Events),{show_edge:function(o,s){var c;return new(c=function(s){function c(){return this._onClose=t(this._onClose,this),this._onRequestIntro=t(this._onRequestIntro,this),c.__super__.constructor.apply(this,arguments)}return e(c,s),c.prototype.tpl=o(".js-metadata-row-template").html(),c.prototype.events={"change .js-context-select":"_onContextSelect","change .js-relationship-select":"_onRelationshipSelect","click .js-add-metadatas":"_onAddMetadatas","click .js-remove-metadata":"_onRemoveMetadata","click .js-confirm-metadata":"_onConfirmMetadata","click .js-unconfirm-metadata":"_onRemoveMetadata","click .js-request-intro":"_onRequestIntro","click .js-close":"_onClose","click .js-undo":"_onUndo","click .js-disconnect":"_onDisconnect","click .js-cancel-metadata":"_onCancelMetadata","click .js-verify-request":"_onVerifyRequest","click .js-next":"_onClickNext"},c.prototype.initialize=function(){var t,e,n,i,r,o,s,l;for(this.source=this.$el.data("source"),this.neighbor_id=this.$el.data("neighborId"),this.neighbor_first_name=this.$el.data("neighborFirstName"),this.user_graph_request_id=this.$el.data("userGraphRequestId"),a.track("UserGraph.MetadataShow",{source:this.source,neighbor_id:this.neighbor_id}),this.$el.data("track_guesses")&&a.track("UserGraph.NumGuesses",{source:this.source,neighbor_id:this.neighbor_id,num_guesses:this.$el.data("metadata").length}),this.metadata={},o=this.$el.data("metadata"),t=0,n=o.length;n>t;t++)r=o[t],this._addMetadataRow(r);for(this.context_map=this.$(".js-add-metadata-container").data("context_map"),this.$(".js-loading-container").hide(),this.$(".js-show-edge-container").show(),this.$(".js-disconnect").magnificPopup({type:"ajax"}),this.freeform_relationships=["co-worker","collaborator","classmate","mentor","mentee","advisor","advisee","manager","employee"],s=this.freeform_relationships,e=0,i=s.length;i>e;e++)l=s[e],this.context_map[l]||(this.context_map[l]=[]);return this.context_free_relationships=["family","friend","acquaintance"],this.$(".tiptip, .js-pending-button").qtip(),this.$(".tiptip").data("hide_tooltip_on_launch")?this.$(".tiptip").qtip("disable"):void 0},c.prototype._addMetadataRow=function(t){return this.metadata[t.id]=t,this.$(".js-existing-metadata-container").append(i.render(this.tpl,t))},c.prototype._onAddMetadatas=function(){return this.$(".js-add-metadatas-button-container").hide(),this.$(".js-add-metadatas-container").show(),a.track("UserGraph.ShowAddMetadata",{source:this.source,neighbor_id:this.neighbor_id})},c.prototype._onRelationshipSelect=function(){var t;return t=this.$(".js-relationship-select").val(),this.context_free_relationships.indexOf(t)>-1?(this.$(".js-context-autocomplete-container").empty().hide(),this.$(".js-context-select-container").addClass("u-hidden"),this.$(".js-context-select-at").addClass("u-hidden"),void this._onAddMetadata()):(0===this.$(".js-context-select-container").length?this._showAutocompleteContext():(this._refreshContextSelect(t),this.$(".js-context-select-container").removeClass("u-hidden"),this.$(".js-context-select-at").removeClass("u-hidden")),a.track("UserGraph.SelectRelationship",{source:this.source,neighbor_id:this.neighbor_id,relationship:t}))},c.prototype._onContextSelect=function(){var t;return t=this.$(".js-context-select").val(),a.track("UserGraph.SelectContext",{source:this.source,neighbor_id:this.neighbor_id,context:t}),"other"===t?this._showAutocompleteContext():(this.$(".js-context-autocomplete-container").empty().hide(),this._onAddMetadata())},c.prototype._showAutocompleteContext=function(){var t,e,i,r;return this.$(".js-context-autocomplete-container").empty().removeClass("u-hidden"),i=n("<input>",{type:"text","class":"js-context-autocomplete context-autocomplete"}),this.$(".js-context-autocomplete-container").append(i),r=this.$(".js-relationship-select").val(),"classmate"!==r?(e="Startup",i.attr("placeholder","Type company name"),t=new l.TypedAutocomplete({el:i,types:["Startup"]})):"classmate"===r&&(e="NewTag",i.attr("placeholder","Type college name"),t=new l.TagAutocomplete({el:i,tag_type:"CollegeTag"})),this.listenTo(t,"select",function(t){return function(n){var i;return i="NewTag"===e?n.tag.id:n.id,t._onAddMetadata(i,e)}}(this)),this.$(".js-context-autocomplete").focus()},c.prototype._refreshContextSelect=function(t){var e,i,r,o,a;if(this.$(".js-context-select").empty(),this.context_map[t].length>0){for(this.$(".js-context-select").append(n("<option>",{value:"",disabled:!0}).text("Choose One")),a=this.context_map[t],i=0,r=a.length;r>i;i++)e=a[i],o=e.name.length>25?e.name.slice(0,23)+"...":e.name,this.$(".js-context-select").append(n("<option>",{value:e.id,title:e.name}).text(o));this.$(".js-context-select").val("")}return this.freeform_relationships.indexOf(t)>-1&&(this.$(".js-context-select").append(n("<option>",{value:"other"}).text("Other")),0===this.context_map[t].length)?void this._showAutocompleteContext():this.$(".js-context-autocomplete-container").empty().addClass("u-hidden")},c.prototype._refreshRelationshipSelect=function(){return r.keys(this.context_map).length?(this.$(".js-relationship-select").val(r.keys(this.context_map)[0]),this._onRelationshipSelect()):void 0},c.prototype._onAddMetadata=function(t,e){var i,r,s;if(r=this.$(".js-relationship-select").val()){if(this.context_free_relationships.indexOf(r)>-1)t=null,e=null;else if(!e){if(i=this.$(".js-context-select").val(),"other"===i)return;if(!i)return;s=i.indexOf("_"),t=i.slice(0,s),e=i.slice(s+1)}if(t&&e||this.context_free_relationships.indexOf(r)>-1)return o(".js-errors-container").slideUp(),this.$(".js-add-metadata-container").hide(),this.$(".js-add-metadata-loading-container").show(),n.ajax({url:this.$(".js-add-metadata-container").data("add_url"),type:"POST",data:{"user_graph_edge_metadata[context_id]":t,"user_graph_edge_metadata[context_type]":e,"user_graph_edge_metadata[relationship]":r,"user_graph_edge_metadata[user_graph_edge_id]":this.$(".js-add-metadata-container").data("user_graph_edge_id")},success:function(t){return function(n){return t.metadata[n.id]||t._addMetadataRow(n),t.$(".js-existing-metadata-container").animate({scrollTop:t.$(".js-metadata-container").last().offset().top}),t.$(".js-add-metadata-loading-container").hide(),t.$(".js-add-metadata-container").show(),t.$(".js-context-autocomplete-container").empty().addClass("u-hidden"),t.$(".js-context-select-container").addClass("u-hidden"),t.$(".js-context-select-at").addClass("u-hidden"),t.$(".js-relationship-select").val(""),t._enableDoneButton(),t.$(".js-verify-nag").remove(),a.track("UserGraph.AddMetadata",{source:t.source,neighbor_id:t.neighbor_id,relationship:r,context_type:e})}}(this)})}},c.prototype._onRemoveMetadata=function(t){var e,i;return i=n(t.target).parents(".js-metadata-container"),i.find(".js-metadata-content").empty().append(n(this.$(".js-loading-container")[0]).clone().show()),e=this.metadata[i.data("id")],o(".js-errors-container").slideUp(),n.ajax({url:i.data("remove_url"),type:"POST",success:function(t){return function(n){return n.verifyable&&0!==t.$(".js-verify-request").length||t._disableDoneButton(),i.slideUp(300,function(){return i.remove()}),delete t.metadata[e.id],a.track("UserGraph.RemoveMetadata",{source:t.source,neighbor_id:e.neighbor_id,relationship:e.relationship,context_type:e.context_type,guessed:e.guessed,is_inviter:e.is_inviter})}}(this)})},c.prototype._onConfirmMetadata=function(t,e){var r;return e||(e=n(t.target).parents(".js-metadata-container")),e.find(".js-metadata-content").empty().append(n(this.$(".js-loading-container")[0]).clone().show()),r=this.metadata[e.data("id")],n.ajax({url:e.data("confirm_url"),type:"POST",success:function(t){return function(n){return e.empty().append(i.render(t.tpl,n.metadata)),t._enableDoneButton(),t.$(".js-verify-nag").remove()}}(this)},a.track("UserGraph.ConfirmMetadata",{source:this.source,neighbor_id:r.neighbor_id,relationship:r.relationship,context_type:r.context_type,guessed:r.guessed,is_inviter:r.is_inviter}))},c.prototype._onCancelMetadata=function(){return this.$(".js-context-select-container").addClass("u-hidden"),this.$(".js-context-select-at").addClass("u-hidden"),this.$(".js-relationship-select").val("")},c.prototype._onVerifyRequest=function(){var t;return t=this.$(".js-verify-request"),t.hasClass("c-button--disabled")?void 0:(o(".js-errors-container").slideUp(),t.addClass("c-button--loading"),n.ajax({url:t.data("url"),type:"POST",success:function(t){return function(){return u.trigger("user_graph_update"),u.trigger("close_graph_modal",{neighbor_id:t.neighbor_id,connected:!0}),a.track("UserGraph.VerifyRequest",{source:t.source,neighbor_id:t.neighbor_id}),n.magnificPopup.close()}}(this),error:function(){return function(e){return t.removeClass("c-button--loading"),u.trigger("user_graph_update"),o(".js-errors").html(e.responseJSON.error),o(".js-errors-container").slideDown()}}(this)}))},c.prototype._onRequestIntro=function(){return n.magnificPopup.close()},c.prototype._onClose=function(){var t;return this._onAddMetadata(),this.$(".js-close").data("modal")?(n.magnificPopup.close(),t=this.$(".js-metadata-container[data-show_confirm=false]").length>0,u.trigger("close_graph_modal",{neighbor_id:this.neighbor_id,connected:t}),u.trigger("user_graph_update")):window.location=this.$(".js-close").data("url")},c.prototype._onUndo=function(t){var e;return n.post(n(t.target).data("href")),a.track("UserGraph.ConnectUndo",{source:this.source,neighbor_id:this.neighbor_id}),u.trigger("user_graph_update"),e=this.$(".js-metadata-container[data-show_confirm=false]").length>0,u.trigger("close_graph_modal",{neighbor_id:this.neighbor_id,connected:e}),n.magnificPopup.close()},c.prototype._enableDoneButton=function(){return this.$(".js-verify-request, .js-next").removeClass("c-button--disabled disabled-link"),this.$(".js-verify-request").removeClass("c-button--gray"),this.$(".js-verify-request").addClass("c-button--blue"),this.$(".tiptip").qtip("disable")},c.prototype._disableDoneButton=function(){return this.$(".js-verify-request").removeClass("c-button--blue"),this.$(".js-verify-request, .js-next").addClass("c-button--disabled disabled-link"),this.$(".js-verify-request").addClass("c-button--gray"),this.$(".tiptip").qtip("enable")},c.prototype._onClickNext=function(){var t,e;return u.trigger("intro_clicked_next"),u.trigger("close_graph_modal",{neighbor_id:this.neighbor_id}),n.magnificPopup.close(),t=this.$(".js-metadata-container[data-show_confirm=false]").length>0,e="message_button"===this.source||"people_message_button"===this.source,e&&t?n.facybox({ajax:o(".js-next").data("href")}):void 0},c}(Backbone.View))({el:s})},disconnect_edge:function(t,i){var r;return new(r=function(i){function r(){return r.__super__.constructor.apply(this,arguments)}return e(r,i),r.prototype.events={"click .js-disconnect":"_onDisconnect","click .js-cancel":"_onCancel"},r.prototype.initialize=function(){return this.neighbor_id=this.$el.data("neighborId"),this.source=this.$el.data("source"),this.modal=this.$el.data("modal")},r.prototype._onCancel=function(){return a.track("UserGraph.DisconnectCancel",{source:this.source,neighbor_id:this.neighbor_id}),n.magnificPopup.close()},r.prototype._onDisconnect=function(){return n.ajax({url:t(".js-disconnect").data("href"),method:"DELETE",success:function(t){return function(){return a.track("UserGraph.Disconnect",{source:t.source,neighbor_id:t.neighbor_id}),u.trigger("user_graph_update")}}(this)}),n.magnificPopup.close(),s("You are now disconnected."),this.modal?void 0:window.location.href="/"},r}(Backbone.View))({el:i})},connections_index:function(t){return t(".js-more-button").click(function(){return n(this).hide(),t(".js-card-row").show()})},events:function(){return u}}})}).call(this);