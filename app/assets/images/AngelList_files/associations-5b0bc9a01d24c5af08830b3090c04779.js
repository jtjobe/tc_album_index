(function(){var t=function(t,e){return function(){return t.apply(e,arguments)}},e=function(t,e){function i(){this.constructor=t}for(var r in e)n.call(e,r)&&(t[r]=e[r]);return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t},n={}.hasOwnProperty,i=[].slice;define(["jquery","backbone","underscore","lib/flash","lib/partials","lib/transitional_autocomplete","models/new_tagging","models/new_tagging_meta_data","models/new_tag","models/project","models/collaborator_tagging","models/job_listing","models/office_space","models/office_space_tenant","models/repository","models/user","models/startup","models/startup_role","models/startup_round","models/startup_round_participant","css!coffeescripts/lib/associations"],function(n,r,o,a,s,l,u,c,d,p,h,f,g,m,v,y,_,b,w,x){var k,C,A,S,T,N,E,D,$,j,I;return j=o.template("<div class='"+s.classNames("coffeescripts/lib/associations").join(" ")+" association'>\n  <% if (typeof url === 'undefined') { %>\n    <span class='association_name'><%- name %></span>\n  <% } else { %>\n    <a class='association_name' href='<%- url %>' target='_blank'><%- name %></a>\n  <% } %>\n  <% if (typeof allowDelete === 'undefined' || allowDelete) { %>\n    <span class='destroy'>&times;</span>\n  <% } %>\n</div>"),I=o.template("<div class='g-lockup medium'>\n  <div class='photo'><img src='<%- photo %>' /></div>\n    <div class='text'>\n      <div class='name'>\n        <a href='<%- url %>' target='_blank'><%- name %></a>\n        <% if (typeof allowDelete === 'undefined' || allowDelete) { %>\n          <span class='destroy'>&times;</span>\n        <% } %>\n      </div>\n    </div>\n  </div>\n</div>"),{AssociationField:k=function(r){function a(){return this.associations=t(this.associations,this),this._submit=t(this._submit,this),this._keypress=t(this._keypress,this),this._click_destroy=t(this._click_destroy,this),this._select=t(this._select,this),a.__super__.constructor.apply(this,arguments)}return e(a,r),a.prototype.associationFromSelect=function(){throw new Error("Subclasses must override")},a.prototype.associationFromSubmit=function(){throw new Error("Subclasses must override")},a.prototype.renderInnerContainer=function(){return n("<div class='"+s.classNames("coffeescripts/lib/associations").join(" ")+" container' />")},a.prototype.renderAssociation=function(){throw new Error("Subclasses must override")},a.prototype.renderEmpty=function(t){return this.$container.toggle(!t)},a.prototype.initializeAutocomplete=function(){throw new Error("Subclasses must override")},a.prototype.destroySelector=".destroy",a.prototype.submitSelector=".submit",a.prototype.input=function(){return this.$("input[type=text]")[0]},a.prototype.isEditable=function(){return this._editable||(this._editable=null!=this.input()),this._editable},a.prototype.render=function(){var t,e,i;return e=this.$container,null==this.$container?this:(t=this.associations(),e.empty(),this.renderEmpty(0===t.length),t.length>0?(i=this.renderInnerContainer(),e.append(i),o.each(t,function(t){return function(e){var r;return r=n(t.renderAssociation(e)),r.data("association",e),r.addClass("association_parent",!0),r.appendTo(i)}}(this))):void 0)},a.prototype.initialize=function(t){if(this.options=t,null==this.collection)throw new Error("Collection must be provided");if(null==t.container)throw new Error("Association container must be provided, (or you can pass container: false if no container exists)");return this.$container=t.container?n(t.container):null,this.listenTo(this.collection,"add remove change reset",o.throttle(function(t){return function(){return t.render(),t.trigger("change",t)}}(this),100)),this.autocomplete=this.initializeAutocomplete(),this.listenTo(this.autocomplete,"select",this._select),this.render()},a.prototype.events=function(){var t;return t={},t["click "+o.result(this,"destroySelector")]="_click_destroy",t["click "+o.result(this,"submitSelector")]="_submit",t.keypress="_keypress",t},a.prototype._select=function(){var t,e;return t=1<=arguments.length?i.call(arguments,0):[],e=this.associationFromSelect.apply(this,t),this.addAssociation(e),n(this.input()).val(""),!0},a.prototype._click_destroy=function(t){var e;return e=n(t.currentTarget).closest(".association_parent"),e.fadeOut("fast",function(t){return function(){return t.removeAssociation(e.data("association"))}}(this)),!0},a.prototype._keypress=function(t){return 13===t.keyCode&&n(this.input()).is(t.srcElement)&&this._submit(t),!0},a.prototype._submit=function(t){var e;return t.preventDefault(),e=this.associationFromSubmit(n(this.input()).val(),t),e&&(this.addAssociation(e),n(this.input()).val("")),!0},a.prototype.associations=function(){return this.collection.models},a.prototype.addAssociation=function(t){return t.save(),this.collection.add(t)},a.prototype.removeAssociation=function(t){return t.destroy()},a}(r.View),StartupField:N=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return e(n,t),n.prototype.initialize=function(t){return this.collection||(this.collection=t.collection||v.get(_)),n.__super__.initialize.apply(this,arguments)},n.prototype.associationFromSubmit=function(){return null},n.prototype.associationFromSelect=function(t,e){return e.model},n.prototype.renderAssociation=function(t){return I({name:t.get("company_name"),url:t.get("slug_url"),photo:t.get("logo_url"),allowDelete:this.isEditable()})},n.prototype.addAssociation=function(t){return this.collection.add(t)},n.prototype.removeAssociation=function(t){return this.collection.remove(t)},n.prototype.initializeAutocomplete=function(){var t;return t={el:this.input(),model:new _},new l.TagAutocomplete(t)},n}(k),UserField:$=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return e(n,t),n.prototype.initialize=function(t){return this.collection||(this.collection=t.collection||v.get(y)),n.__super__.initialize.apply(this,arguments)},n.prototype.associationFromSubmit=function(){return null},n.prototype.associationFromSelect=function(t){return new y({id:t.id,display_name:t.name,slug_url:t.url,pic:t.pic})},n.prototype.renderAssociation=function(t){return j({name:t.get("display_name"),url:t.get("slug_url"),allowDelete:this.isEditable()})},n.prototype.addAssociation=function(t){return this.collection.add(t)},n.prototype.removeAssociation=function(t){return this.collection.remove(t)},n}(k),NewTaggingField:S=function(t){function i(){return i.__super__.constructor.apply(this,arguments)}return e(i,t),i.prototype.initialize=function(){return this.collection||(this.collection=v.get(u)),i.__super__.initialize.apply(this,arguments)},i.prototype.associations=function(){return this.collection.where({new_taggable_type:this.options.new_taggable_type,new_taggable_id:this.options.new_taggable_id,new_taggable_field:this.options.new_taggable_field})},i.prototype.baseAttributes=function(){var t,e,n,i,r;for(t={},r=["new_taggable_field","new_taggable_type","new_taggable_id"],n=0,i=r.length;i>n;n++){if(e=r[n],null==this.options[e])throw new Error("Option '"+e+"' is required");t[e]=this.options[e]}return t},i.prototype.associationFromSelect=function(t,e,i){return t.new_tagging_field_unmatched?this.associationFromSubmit(t.term,i):new u(n.extend({},this.baseAttributes(),{new_tag_id:e.model.id,new_tag:e.model.toJSON()}))},i.prototype.associationFromSubmit=function(t){return new u(n.extend({},this.baseAttributes(),{new_tag:{name:t,tag_type:this.options.tag_type,display_name:t.toTitleCase()}}))},i.prototype.renderAssociation=function(t){return j({name:t.get("new_tag").display_name,url:t.get("new_tag").slug_url,allowDelete:this.isEditable()})},i.prototype.initializeAutocomplete=function(){var t,n;return n={el:this.input(),parameters:{tag_type:this.options.tag_type||function(){throw new Error("Option 'tag_type' is required")}(),new_taggable_field:this.options.new_taggable_field||function(){throw new Error("Option 'new_taggable_field' is required")}(),new_taggable_type:this.options.new_taggable_type||function(){throw new Error("Option 'new_taggable_type' is required")}(),new_taggable_id:this.options.new_taggable_id},model:new d({tag_type:this.options.tag_type})},t=this.options.allowUnmatched,new(function(n){function i(){return i.__super__.constructor.apply(this,arguments)}return e(i,n),i.prototype.process_response=function(e,n){var r;return r=i.__super__.process_response.apply(this,arguments),t&&r.push({value:{new_tagging_field_unmatched:!0,term:n},label:l.more_template("Add")({term:n})}),r},i}(l.TagAutocomplete))(n)},i.prototype.addAssociation=function(t){return t.save(null,{error:function(e){return function(i,r){var s;return s=n.parseJSON(r.responseText),s.errors&&a(o.values(s.errors).join("; "),4e3),e.collection.remove(t)}}(this)}),this.collection.add(t)},i}(k),NewTagField:A=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return e(n,t),n.prototype.associationFromSubmit=function(){return null},n.prototype.associationFromSelect=function(t){return new d(t.tag)},n.prototype.initialize=function(t){if(this.tagType||(this.tagType=null!=t?t.tagType:void 0),null==this.tagType)throw new Error("Tag type is required");return n.__super__.initialize.apply(this,arguments)},n.prototype.renderAssociation=function(t){return j({name:t.get("display_name"),url:t.get("slug_url"),allowDelete:this.isEditable()})},n.prototype.addAssociation=function(t){return this.collection.add(t)},n.prototype.removeAssociation=function(t){return this.collection.remove(t)},n.prototype.initializeAutocomplete=function(){var t;return t={el:this.input(),tag_type:this.tagType},new l.TagAutocomplete(t)},n}(k),StartupRoleField:E=function(t){function i(){return i.__super__.constructor.apply(this,arguments)}return e(i,t),i.prototype.initialize=function(){return this.collection||(this.collection=v.get(b)),i.__super__.initialize.apply(this,arguments)},i.prototype.associations=function(){return this.collection.where({tagged_id:this.options.tagged_id,tagged_type:this.options.tagged_type,role:this._role()})},i.prototype.baseAttributes=function(){var t,e,n,i,r;for(t={},r=["tagged_id","tagged_type"],n=0,i=r.length;i>n;n++){if(e=r[n],null==this.options[e])throw new Error("Option '"+e+" is required");t[e]=this.options[e]}return t.role=this._role(),t},i.prototype._role=function(){if(null==this.options.role)throw new Error("Option 'role' is required");return this.options.role},i.prototype.initializeAutocomplete=function(){return new l.TagAutocomplete({el:this.input(),model:new _})},i.prototype.associationFromSelect=function(t,e){return new b(n.extend({},this.baseAttributes(),{startup_id:e.model.id,startup_company_name:e.model.get("company_name"),startup_slug_url:e.model.get("slug_url"),startup_avatar:e.model.get("avatar"),startup_high_concept:e.model.get("high_concept")}))},i.prototype.associationFromSubmit=function(t){return t?new b(n.extend({},this.baseAttributes(),{company_name:t,startup_company_name:t})):void 0},i.prototype.renderAssociation=function(t){return j({name:t.get("startup_company_name"),url:t.get("startup_slug_url")})},i}(k),StartupRoundParticipantField:D=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return e(n,t),n.prototype.initialize=function(){if(!(null!=this.model&&this.model instanceof w))throw new Error("Must provide a StartupRound model");if(!this.model.has("startup_id"))throw new Error("Must provide a startup ID");return n.__super__.initialize.apply(this,arguments)},n.prototype.renderAssociation=function(t){return j({url:t.get("participant_slug_url"),name:t.get("participant_to_s")})},n.prototype.initializeAutocomplete=function(){return new l.TagAutocomplete({el:this.input(),tag_type:["User","Startup"]})},n.prototype.associationFromSubmit=function(){return!1},n.prototype.associationFromSelect=function(t){return new x({participant_id:t.tag.id,participant_type:t.tag.model,startup_round_id:this.model.id,participant_slug_url:t.tag.slug_url,participant_to_s:t.tag.display_name})},n.prototype.addAssociation=function(t){return this.collection.add(t)},n.prototype.associations=function(){return this.model.isNew()?this.collection.models:this.collection.where({startup_round_id:this.model.id})},n}(k),CollaboratorTaggingField:C=function(t){function i(){return i.__super__.constructor.apply(this,arguments)}return e(i,t),i.prototype.initialize=function(){if(null==this.model)throw new Error("Must provide a model");return i.__super__.initialize.apply(this,arguments)},i.prototype.collaborationType=function(){switch(!1){case!(this.model instanceof p):return"Project";case!(this.model instanceof f):return"JobListing";case!(this.model instanceof u):return"NewTagging";case!(this.model instanceof c):return"NewTaggingMetaData";default:throw new Error("Collaboration type not allowed")}},i.prototype.renderAssociation=function(t){return j({url:t.get("collaborator_slug_url")||void 0,name:t.get("collaborator_to_s")})},i.prototype.initializeAutocomplete=function(){return new l.TypedAutocomplete({el:this.input(),types:["User"],canSelectUnmatchedQuery:this.options.unmatched})},i.prototype.associationFromSubmit=function(t){return new h({collaboration_id:this.model.id,collaboration_type:this.collaborationType(),invited_name:t,collaborator_to_s:t})},i.prototype.associationFromSelect=function(t){return new h({collaboration_id:this.model.id,collaboration_type:this.collaborationType(),collaborator_id:t.id,collaborator_type:"User",collaborator_slug_url:t.url,collaborator_to_s:t.name,collaborator_avatar:t.pic})},i.prototype.addAssociation=function(t){return t.save(null,{error:function(e){return function(i,r){var a;return a=n.parseJSON(r.responseText),a.errors&&e.$(".error").html(o.values(a.errors)[0]).fadeIn().delay(4e3).fadeOut(),e.collection.remove(t)}}(this)}),this.collection.add(t)},i.prototype.associations=function(){return this.collection.models},i}(k),OfficeSpaceTenantField:T=function(t){function i(){return i.__super__.constructor.apply(this,arguments)}return e(i,t),i.prototype.initialize=function(){if(!(null!=this.model&&this.model instanceof g))throw new Error("Must provide a OfficeSpace model");return i.__super__.initialize.apply(this,arguments)},i.prototype.renderAssociation=function(t){return j({url:t.get("tenant_slug_url"),name:t.get("tenant_to_s")})},i.prototype.initializeAutocomplete=function(){return new l.TypedAutocomplete({el:this.input(),types:["User","Startup"],canSelectUnmatchedQuery:this.options.unmatched})},i.prototype.associationFromSelect=function(t){return new m({office_space_id:this.model.id,tenant_id:t.id,tenant_type:"User",tenant_slug_url:t.url,tenant_to_s:t.name})},i.prototype.addAssociation=function(t){return t.save(null,{error:function(e){return function(i,r){var a;return a=n.parseJSON(r.responseText),a.errors&&n(e.el).find(".error").html(o.values(a.errors)[0]).fadeIn().delay(4e3).fadeOut(),e.collection.remove(t)}}(this)}),this.collection.add(t)},i.prototype.associations=function(){return this.model.isNew()?this.collection.models:this.collection.where({office_space_id:this.model.id})},i}(k)}})}).call(this);