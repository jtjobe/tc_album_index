(function(){var t=function(t,e){return function(){return t.apply(e,arguments)}},e=function(t,e){function i(){this.constructor=t}for(var r in e)n.call(e,r)&&(t[r]=e[r]);return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t},n={}.hasOwnProperty;define(["module","require","jquery","backbone","underscore","lib/partials","lib/string","lib/transitional_autocomplete","models/repository","models/slug","jquery.atwho","jquery.autosize","jquery.caret","css!coffeescripts/lib/mentions"],function(n,i,r,o,a,s,l,u,c,d){var p,h,f,g,m,v,_;return g=a.uniqueId("lib_mentions"),h=a.template("<span\nclass='"+s.classNames("coffeescripts/lib/mentions").join(" ")+" autocomplete_mention'>@<%- displayName || slug %></span>"),_=a.template('<a class="at_mention_link" data-type="<%- sluggable_type %>" data-id="<%- sluggable_id %>" href="<%- name %>">\n  <span class="at_mention_symbol">@</span><span class="at_mention_slug"><%- sluggable_to_s %></span>\n</a>'),p={},f=function(t){return p[t]||(p[t]=r.get("/mentions/search",{mention:t},null,"json"),a.delay(function(){return p[t]=null},6e4)),p[t]},v="\\s<>&\\(\\)\\?!,.:;'\"",m=function(t,e,n){var i,r;return i=new RegExp("(?=["+v+"\\"+e+"])","g"),r=a.map(t.split(i),function(){return function(t){return t[0]===e&&t.length>1?n(t.slice(1)):t}}(this)),r.join("")},{Autocomplete:function(n){function i(){return this._search=t(this._search,this),this._transformTokens=t(this._transformTokens,this),this.updateTarget=t(this.updateTarget,this),this.render=t(this.render,this),i.__super__.constructor.apply(this,arguments)}return e(i,n),i.prototype.results=function(t){return 0===t.length?[]:r.when(f(t))},i.prototype.renderMention=function(t){var e,n;if(n=t.get("name"),e=t.get("sluggable_to_s"),null==e)throw new Error("No display name loaded for slug");return h({slug:n,displayName:e})},i.prototype.renderSelect=function(t){return u.render_item({image:t.pic,main_text:t.highlighed_name,detail_text:t.desc})},i.prototype.resultToSlug=function(t){var e;return e=this.collection.findWhere({name:t.slug})||new d,e.set({name:t.slug,sluggable_to_s:a.unescape(t.name),sluggable_id:t.id,sluggable_type:t.type})},i.prototype.initialize=function(t){if(this.collection||(this.collection=c.get(d)),this.$el.is(":input"))throw new Error("Must be applied to a container element, not to an input directly");if(this.$target=r(t.target),!this.$target.is(":input"))throw new Error("Must provide a target input (generally hidden) to contain the value to submit to the server");return this._initializeElement(),this.$editable=this._initializeEditable(),this.$highlighter=this._initializeHighlighter(),this._$intermediary=r('<input type="hidden" value=""/>'),this.render()},i.prototype.render=function(){return this._nestedRender?void 0:(this._nestedRender=!0,this._$intermediary.val(this.$target.val().replace(new RegExp("\\"+this._at+"(?=[^\\s])","g"),this._atReplacement)),this._renderEditable(),this._renderHighlighter(),this._nestedRender=!1)},i.prototype.updateTarget=function(){return this._nestedUpdateTarget?void 0:(this._nestedUpdateTarget=!0,this._$intermediary.val(this.$editable.val().replace(new RegExp("\\"+this._marker+"[^\\"+this._marker+"]+(?=\\"+this._marker+"(["+v+"]|$))","g"),function(t){return function(e){var n,i;return n=e.slice(1),i=(t._slugNamesByRenderedText||{})[n],null!=i?""+t._atReplacement+i:e}}(this)).replace(new RegExp("\\"+this._marker,"g"),"")),this.$target.val(this._$intermediary.val().replace(new RegExp("\\"+this._atReplacement,"g"),this._at)).trigger("change"),this._renderEditable(),this._renderHighlighter(),this._nestedUpdateTarget=!1)},i.prototype.events={change:"updateTarget",input:"updateTarget",keyup:"updateTarget"},i.prototype.delegateEvents=function(){var t,e;return i.__super__.delegateEvents.apply(this,arguments),this.$target.on("change",function(t){return function(){return t._nestedUpdateTarget?void 0:t.render()}}(this)),this.$editable.atwho({at:this._at,alias:"mentions",tpl:function(t){return function(e){var n,i;return n=t.resultToSlug(e),i=r(t._renderMentionWithMetadata(n)).text(),r(t.renderSelect(e)).wrap("<li>").parent().attr("data-value",i).attr("data-"+g+"_slug",JSON.stringify(n.toJSON())).wrap("<p>").parent().html()}}(this),callbacks:{highlighter:function(t){return t},remote_filter:this._search,tpl_eval:function(t,e){return t(e)},sorter:function(t,e){return e},matcher:function(t,e,n){var i,r;return t=t.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),n&&(t="(?:^|\\s)"+t),r=new RegExp(t+"([ A-Za-z0-9_+-]*)$|"+t+"([^\\x00-\\xff]*)$","gi"),i=r.exec(e),i?i[2]||i[1]:null}}}),t=this.$editable.data("atwho").controllers["@"],e=t.insert,t.insert=function(n){return function(i,r){var o;if(o=r.data(g+"_slug"),null==o.name)throw new Error("Slug name expected in attributes");return n.collection.findWhere({name:o.name})||n.collection.add(o),e.call(t,""+n._marker+i+n._marker,r)}}(this)},i.prototype.undelegateEvents=function(){return i.__super__.undelegateEvents.apply(this,arguments),this.$target.off("change",this.render),this.$editable.atwho("destroy")},i.prototype._at="@",i.prototype._marker=String.fromCharCode(8203),i.prototype._atReplacement=String.fromCharCode(8205),i.prototype._initializeElement=function(){return this.$el.css({position:"relative"}),this.$el.zIndex(this.$el.zIndex()+1)},i.prototype._initializeEditable=function(){var t;return t=this.$("textarea")[0],t||(t=r("<textarea />"),t.appendTo(this.$el)),t=r(t),t.autosize(),t.css("background-color","transparent"),t},i.prototype._initializeHighlighter=function(){var t,e,n,i,o,a,l,u,c;for(e=r("<div class='"+s.classNames("coffeescripts/lib/mentions").join(" ")+" highlighter' />").insertBefore(this.$editable),c=["fontFamily","fontSize","fontWeight","fontStyle","letterSpacing","textTransform","wordSpacing","textIndent","lineHeight","minHeight","borderRadius"],l=["Left","Right","Top","Bottom"],n=0,o=l.length;o>n;n++)t=l[n],c.push("padding"+t),c.push("margin"+t),c.push("border"+t+"Width");for(i=0,a=c.length;a>i;i++)u=c[i],e.css(u,this.$editable.css(u));return e},i.prototype._renderEditable=function(){var t,e,n,i,o,a,s,l;if(l=this._transformTokens(!1,function(t){return function(e){var n;return n=t._renderMentionWithMetadata(e),t._marker+r(n).text()+t._marker}}(this)),e=this.$editable.val(),e!==l){if(n=this.$editable.is(":focus"),s=0,n)for(t=this.$editable.caret("pos"),s=0,i=o=0,a=t-1;a>=0?a>=o:o>=a;i=a>=0?++o:--o)l[s]===e[i]&&s++;if(this.$editable.val(l),this.$editable.trigger("autosize.resize"),n)return this.$editable.caret("pos",s)}},i.prototype._renderHighlighter=function(){return this.$highlighter.html(this._transformTokens(!0,function(t){return function(e){return t._renderMentionWithMetadata(e)}}(this)))},i.prototype._transformTokens=function(t,e){var n;return n=this._$intermediary.val(),t&&(n=a.escape(n)),m(n,this._atReplacement,function(t){return function(n){var i;return i=t.collection.findWhere({name:n}),null!=i?e(i):(t._loadData(),""+t._at+n)}}(this))},i.prototype._renderMentionWithMetadata=function(t){var e,n;if(!t.has("name"))throw new Error("Slug name expected in model");if(this._renderedMentions||(this._renderedMentions={}),this._slugNamesByRenderedText||(this._slugNamesByRenderedText={}),!this._renderedMentions[t.get("name")]){for(n=r(this.renderMention(t)).attr("data-marker",this._marker),e=!0;null!=this._slugNamesByRenderedText[n.text()];)n.html(n.html()+(e?"&nbsp;":" ")),e=!e;this._renderedMentions[t.get("name")]=n.wrap("<p>").parent().html(),this._slugNamesByRenderedText[n.text()]=t.get("name")}return this._renderedMentions[t.get("name")]},i.prototype._search=function(t,e){var n;return this._searchId||(this._searchId=0),this._searchId++,n=this._searchId,r.when(this.results(t)).done(function(t){return function(i){return t._searchId===n?e(i):void 0}}(this))},i.prototype._loadData=a.once(function(){return r.get("/mentions/init_mentions",{text:this.$target.val()},function(t){return function(e){var n,i,r,o,a;o=e.active_mentions||{};for(i in o)n=o[i],r=n.slug.replace(/^@/,""),a=t.collection.findWhere({name:r})||new d,a.set({name:r,sluggable_to_s:i.replace(/^@/,""),sluggable_type:n.type,sluggable_id:n.id}),t.collection.add(a);return t.render()}}(this),"json")}),i}(o.View),UpdatingField:function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return e(n,t),n.prototype.initialize=function(t){if(this.collection||(this.collection=c.get(d)),this.field=t.field,null==this.field)throw new Error("Must provide a field to listen to");return this.listenTo(this.model,"change:"+this.field,this.render)},n.prototype.render=function(){var t,e,n;return e=this._preprocessText(),n=this,t=function(){var e;return r(this).contents().length>0?r(this).contents().each(t):(e=m(r(this).text(),"@",function(){return function(t){var e;return e=n.collection.findWhere({name:t}),null!=e?n.renderMention(e):"@"+t}}(this)),null!=r(this).html()?r(this).html(e):r(this).replaceWith(e))},this.$el.empty().append(r(e).each(t)),this},n.prototype.renderMention=function(t){return _(t.toJSON())},n.prototype._preprocessText=function(){return l.link_and_format(this.model.escape(this.field))},n}(o.View)}})}).call(this);