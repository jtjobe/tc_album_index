(function(){var t=function(t,e){return function(){return t.apply(e,arguments)}},e=function(t,e){function i(){this.constructor=t}for(var r in e)n.call(e,r)&&(t[r]=e[r]);return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t},n={}.hasOwnProperty,i=[].slice;define(["jquery","backbone","underscore","models/new_tagging","lib/environment","lib/partials","css!coffeescripts/lib/transitional_autocomplete"],function(n,r,o,a,s,l){var u,c,d,p,h,f,g,m;return f=l.classNames("coffeescripts/lib/transitional_autocomplete"),m=o.template("<div class='"+f.join(" ")+' list_item <%- typeof containing_class === \'undefined\' ? \'\' : containing_class %>\'>\n  <div class="g-lockup small container">\n    <% if (typeof(image) !== \'undefined\' && image) { %>\n    <div class="photo">\n      <img src="<%- image %>" alt="<%- main_text %>"/>\n    </div>\n    <% } %>\n    <div class="text">\n      <div class="main"><%= main_text %></div>\n      <% if (typeof(detail_text) !== \'undefined\' && detail_text) { %>\n      <div class=\'detail\'><%= detail_text %></div>\n      <% } %>\n    </div>\n  </div>\n</div>'),g=function(t){return o.template("<div class='"+f.join(" ")+" add_item'>"+t+" <span class='matched_substring'><%- '\"' + term + '\"'%></span></div>")},u=function(r){function a(){return this.open=t(this.open,this),this.select=t(this.select,this),this.source=t(this.source,this),this.update_model=t(this.update_model,this),a.__super__.constructor.apply(this,arguments)}return e(a,r),a.prototype.request_options=function(){throw new Error("Subclasses must override")},a.prototype.render_item=function(){throw new Error("Subclasses must override")},a.prototype.update_model=function(t){var e,n;return"function"==typeof(null!=(e=this.model)?e.set_autocomplete_data:void 0)&&this.model.set_autocomplete_data(t),null!=(n=this.model)?n.trigger("autocomplete",t,this):void 0},a.prototype.initialize=function(t){return this.options=t},a.prototype.search=function(){return this.$el.autocomplete("search")},a.prototype.events=function(){return{click:"search"}},a.prototype.autocomplete_options=function(){return{autoFocus:!0,html:!0,delay:s.isDevelopment()?300:50,source:this.source,select:this.select,open:this.open,focus:this.focus}},a.prototype.widget_class=function(){return f.join(" ")+" container"},a.prototype.source=function(t,e){var r,o,a,s;return o=this.request_options(t.term),s=this,r=n.extend({},o,{success:function(){var n,r,a;return n=1<=arguments.length?i.call(arguments,0):[],null!=(r=o.success)&&r.apply(this,n),a=n[2],s.$el.is(":focus")&&s.__last_xhr===a&&s.$el.val()===t.term?e(s.process_response(n[0],t.term)):void 0}}),null!=(a=this.__last_xhr)&&a.abort(),this.__last_xhr=n.ajax(r)},a.prototype.focus=function(){return!1},a.prototype.select=function(t,e){return this.update_model(e.item.value),this.trigger("select",e.item.value,this,t),!1},a.prototype.open=function(t,e){return this.$el.autocomplete("widget").find(".ui-menu-item").attr("aria-label"," "),this.trigger("open",this,t,e)},a.prototype.process_response=function(t,e){var n,i;return i=function(){var i,r,o;for(o=[],i=0,r=t.length;r>i;i++)n=t[i],o.push(function(t){return function(n){return{value:n,label:t.render_item(n,e)}}}(this)(n));return o}.call(this)},a.prototype.delegateEvents=function(t){return a.__super__.delegateEvents.call(this,t),this.$el.autocomplete(this.autocomplete_options()),this.__autocomplete_initialized=!0,n(this.$el.autocomplete("widget")).addClass(this.widget_class())},a.prototype.undelegateEvents=function(t){return a.__super__.undelegateEvents.call(this,t),this.__autocomplete_initialized&&this.$el.autocomplete("destroy"),this.__autocomplete_initialized=!1},a.prototype.highlighted_text=function(t,e){var i,r,a,s,l;for(t=o.escape(t),e=e.trim().toLowerCase(),l=[e].concat(e.split(/\s+/)).concat(e.replace(/[^a-z0-9\ ]/,"").split(/\s+/)),l=o.uniq(l.sort().reverse()),i=0,r=l.length;r>i;i++)s=l[i],""!==s&&(a=new RegExp("\\b("+n.ui.autocomplete.escapeRegex(s)+")(?![^<]*?>)","gi"),t=t.replace(a,"<span class='matched_substring'>$1</span>"));return t},a}(r.View),{BaseAutocomplete:u,render_item:m,SearchAutocomplete:d=function(n){function i(){return this.select=t(this.select,this),i.__super__.constructor.apply(this,arguments)}return e(i,n),i.prototype.request_options=function(t){return{url:"/autocomplete/search",data:{query:t},dataType:"json",type:"get"}},i.prototype.select=function(t,e){return i.__super__.select.call(this,t,e),window.location=e.item.value.url,!1},i.prototype.more_template=function(t){return this._more_template||(this._more_template=g("Search for ")),this._more_template({term:t})},i.prototype.process_response=function(t,e){var n;return n=i.__super__.process_response.call(this,t.results,e),n.push({label:this.more_template(e),value:{url:"/search?q="+e}}),n},i.prototype.render_item=function(t,e){return m({image:null!=t.pic&&t.pic.length>0?t.pic:null,main_text:this.highlighted_text(t.name,o.escape(e)),detail_text:t.type,containing_class:"search"})},i}(u),TypedAutocomplete:h=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return e(n,t),n.prototype.more_template=function(t){return this._more_template||(this._more_template=g("Add new ")),this._more_template({term:t})},n.prototype.request_options=function(t){return{url:"/autocomplete/search",data:{query:t,types:this.options.types,include_exact_match:this.options.include_exact_match,limit:this.options.limit,contain_ids:this.options.contain_ids},dataType:"json",type:"get"}},n.prototype.process_response=function(t,e){var i;return i=n.__super__.process_response.call(this,t.results,e),this.options.canSelectUnmatchedQuery&&i.push({label:this.more_template(e),value:{unmatched:!0,query:e}}),i},n.prototype.render_item=function(t,e){return m({image:null!=t.pic&&t.pic.length>0?t.pic:null,main_text:this.highlighted_text(t.name,e),detail_text:t.type,containing_class:"search"})},n}(u),PeopleAndTagsAutocomplete:c=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return e(n,t),n.prototype.request_options=function(t){return{url:"/autocomplete/people_and_tags",data:{query:t,tag_types:this.options.tag_types},dataType:"json",type:"get"}},n.prototype.widget_class=function(){return n.__super__.widget_class.call(this)+" search"},n.prototype.render_item=function(t,e){return m({image:null!=t.pic&&t.pic.length>0?t.pic:null,main_text:this.highlighted_text(t.name,e),detail_text:t.type,containing_class:"search"})},n}(u),TagAutocomplete:p=function(t){function i(){return i.__super__.constructor.apply(this,arguments)}return e(i,t),i.prototype.request_options=function(t){return{url:"/autocomplete/new_tags",data:this.request_data(t),dataType:"json",type:"get"}},i.prototype.render_item=function(t,e){return m({image:null!=t.tag.pic&&t.tag.pic.length>0?t.tag.pic:null,main_text:this.main_text(t,e),detail_text:this.options.hide_detail_text?void 0:this.detail_text(t,e)})},i.prototype.request_data=function(t){var e,i;if(e={query:t},"function"==typeof(null!=(i=this.model)?i.autocomplete_parameters:void 0)&&n.extend(e,this.model.autocomplete_parameters()),null!=this.options.tag_type&&n.extend(e,{tag_type:this.options.tag_type}),null!=this.options.parameters&&n.extend(e,this.options.parameters),null==e.tag_type)throw new Error("Must provide a tag type. This can either come from the model, or be provided as an explicit tag_type parameter");return e},i.prototype.main_text=function(t,e){return this.highlighted_text(t.tag.display_name,e)},i.prototype.detail_text=function(t){return null!=t.tag.description?t.tag.description:null!=t.counts.User?1===t.counts.User?"1 follower":t.counts.User+" followers":null},i}(u),more_template:g}})}).call(this);