(function(){var t=[].slice,e=function(t,e){function i(){this.constructor=t}for(var r in e)n.call(e,r)&&(t[r]=e[r]);return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t},n={}.hasOwnProperty,i=function(t,e){return function(){return t.apply(e,arguments)}};define(["jquery","backbone","underscore","lib/partials","css!coffeescripts/lib/form"],function(n,r,o,a){var s,l,u,c,d,p,h;return u=function(t,e){var i,r;return t=n(t),e=e.toString(),i={},r=":input[name^='"+e+"[']:not(:file)",n.merge(t.find(r),t.filter(r)).each(function(){var t,r,o,a;if(!n(this).is(":radio")||n(this).is(":checked"))return t=n(this).attr("name").substr(e.length+1),t=t.substr(0,t.length-1),-1!==t.indexOf("][")?(o=t.split("]["),r=o[0],t=o[1],i[r]||(i[r]={}),a=n(this).is(":checkbox")?n(this).is(":checked"):n(this).val(),i[r][t]=a):(a=n(this).is(":checkbox")?n(this).is(":checked"):n(this).val(),i[t]=a),!0}),i},h=function(t,e,i){var r,a,s;return null==i&&(i={}),n(t).parent().hasClass("fieldWithErrors")&&n(t).parent().replaceWith(n(t)),null!=e?(s=i.div?"div":"span",r=n("<"+s+" class='fieldWithErrors'></"+s+">").insertBefore(n(t)),n(t).appendTo(r),a=i.do_not_escape_error?e:o.escape(e),n("<span class='validation-error'>"+a+"</span>").appendTo(r)):void 0},c=function(t){return n(t).parent().hasClass("fieldWithErrors")?n(t).parent().replaceWith(n(t)):void 0},d=function(t){return o.each(t,function(t){return c(t)})},p=function(e,i){return null==i&&(i={}),n.extend({},i,{beforeSend:function(){var r,o;return r=1<=arguments.length?t.call(arguments,0):[],n(":submit, .submit",e).addClass("loading").addClass("c-button--loading"),null!=(o=i.beforeSend)?o.apply(this,r):void 0},complete:function(){var r,o;return r=1<=arguments.length?t.call(arguments,0):[],n(":submit, .submit",e).removeClass("loading").removeClass("c-button--loading").removeAttr("disabled"),null!=(o=i.complete)?o.apply(this,r):void 0}})},{loadingOptions:p,attributes:u,setInputError:h,clearInputError:c,clearInputErrors:d,CharacterCounter:s=function(t){function i(){return i.__super__.constructor.apply(this,arguments)}return e(i,t),i.prototype.template=o.template("<div class='"+a.classNames("coffeescripts/lib/form").join(" ")+" character_counter_template <%- (current > max ? 'above_max' : '') %>'>\n  <span class='current'><%- current %></span>\n  <span class='separator'>/</span>\n  <span class='max'><%- max %></span>\n</div>"),i.prototype.render=function(){return this._$container.html(this.template({current:this.$el.val().length,max:this.max}))},i.prototype.initialize=function(t){if(!this.$el.is(":input"))throw new Error("Must be applied to a form input");if(this.max=t.max,!o.isNumber(this.max))throw new Error("Must provide a maximum character count");return null!=t.container?this._$container=n(t.container):(this._$container=n("<div/>"),this._$container.insertAfter(this.$el)),this.render()},i.prototype.events=function(){var t,e,n,i,r;for(e={},r=["visible","keyup","keydown","change","paste","focus"],n=0,i=r.length;i>n;n++)t=r[n],e[t]="render";return e},i}(r.View),StandardForm:l=function(t){function r(){return this._error=i(this._error,this),this._success=i(this._success,this),this._beforeSubmit=i(this._beforeSubmit,this),this._setErrors=i(this._setErrors,this),this._applySuccessResponse=i(this._applySuccessResponse,this),this._$form=i(this._$form,this),r.__super__.constructor.apply(this,arguments)}return e(r,t),r.prototype.initialize=function(t){var e,n,i;return r.__super__.initialize.call(this,t),this.form_prefix=null!=(e=t.form_prefix)?e:null!=(n=this.model)&&null!=(i=n.constructor)?i.toString():void 0},r.prototype.events=function(){return{submit:function(t){return function(){return t.save(),!1}}(this)}},r.prototype.save=function(t){var e,i,r;if(null==t&&(t={}),r=this,e=n.Deferred(),t=o.clone(t),o.defaults(t,this._defaultOptions()),i={success:function(n,i,o){var a;return r._success(n,i,o),null!=(a=t.success)&&a.call(this,n,i,o),e.resolve(n,i,o)},error:function(n,i,o){var a;return r._error(n,i,o),null!=(a=t.error)&&a.call(this,n,i,o),e.reject(n,i,o)}},1!==this._$form().length)throw new Error("Must provide exactly one form");return this._beforeSubmit()?(this._$form().ajaxSubmit(p(this._$form(),n.extend({},t,i))),e.promise()):void 0},r.prototype._$form=function(){return this.$el.is("form")?this.$el:this.$("form")},r.prototype._applySuccessResponse=function(t){var e;return null!=(e=this.model)?e.set(this.model.parse(t)):void 0},r.prototype._defaultOptions=function(){return{dataType:"json"}},r.prototype._setErrors=function(t){var e,n,i,r,o;d(this._$form().find("label")),t.errors&&(t=t.errors),r=[];for(n in t)e=t[n],e instanceof Array?(o=e[0],i=this.$("label[for='"+this.form_prefix+"_"+n+"']"),r.push((null!=i?i.length:void 0)>0?i.each(function(){return h(this,o)}):"undefined"!=typeof console&&null!==console?console.warn("Error not shown to user: "+n+" "+o):void 0)):r.push("undefined"!=typeof console&&null!==console?console.warn("Unprocessable error: "+e):void 0);return r},r.prototype._beforeSubmit=function(){return this._setErrors([]),this.trigger("request"),!0},r.prototype._success=function(t,e,n){return this._applySuccessResponse(t),this.trigger("sync",t,e,n)},r.prototype._error=function(t,e,i){return this._setErrors(n.parseJSON(t.responseText)),this.trigger("error",t,e,i)},r}(r.View)}})}).call(this);