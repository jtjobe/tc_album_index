(function(){var t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t},e={}.hasOwnProperty,n=function(t,e){return function(){return t.apply(e,arguments)}};define(["jquery","backbone","underscore","lib/associations","lib/partials","lib/transitional_autocomplete","models/new_tag","models/new_tagging","models/startup","models/user"],function(e,i,r,o,a,s,l,u,c,d){var p,h,f,g,m,v,y,_,b,w,x,k,C,A,S,T;return _={initializeInput:function(){return this.$(this.input()).attr("autocomplete","country chromehack"),this._onAssociationChange(),this.listenTo(this.collection,"add remove",function(t){return function(){return t._onAssociationChange(!0)}}(this))},idField:function(){return this.$(".js-tagger-ids")},_onAssociationChange:function(t){return this._updateIdField(),this._hideInputIfGreaterThanMax(t)},_updateIdField:function(){var t,e;return t=function(){var t,n,i,r;for(i=this.collection.models,r=[],t=0,n=i.length;n>t;t++)e=i[t],r.push(e.id);return r}.call(this),this.idField().val(t.join())},_hideInputIfGreaterThanMax:function(t){var e,n;if(n=this.$el.data("max"))return e=this.$(this.input()),this.collection.length<n?(e.show(),t?e.focus():void 0):(e.hide(),this.trigger("filled"))}},b=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.initialize=function(t){var e;return this.collection=new i.Collection(function(){var t,n,i,r;for(i=this.$el.data("existing"),r=[],t=0,n=i.length;n>t;t++)e=i[t],r.push(new l(e));return r}.call(this)),n.__super__.initialize.call(this,r.extend({tagType:this.$el.data("type")+"Tag",container:this.$(".js-association-container")},t)),this.initializeInput()},n}(o.NewTagField),r.extend(b.prototype,_),w=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.initialize=function(t){var e;return this.collection=new i.Collection(function(){var t,n,i,r;for(i=this.$el.data("existing"),r=[],t=0,n=i.length;n>t;t++)e=i[t],r.push(new u(e));return r}.call(this)),n.__super__.initialize.call(this,r.extend({tag_type:this.$el.data("type")+"Tag",new_taggable_field:"tags_"+this.$el.data("field"),new_taggable_type:""+this.$el.data("taggable-type"),new_taggable_id:this.$el.data("id"),container:this.$(".js-association-container")},t)),this.initializeInput()},n}(o.NewTaggingField),r.extend(w.prototype,_),x=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.initialize=function(t){var e;return this.collection=new i.Collection(function(){var t,n,i,r;for(i=this.$el.data("existing"),r=[],t=0,n=i.length;n>t;t++)e=i[t],r.push(new c(e));return r}.call(this)),n.__super__.initialize.call(this,r.extend({container:this.$(".js-association-container")},t)),this.initializeInput()},n}(o.StartupField),r.extend(x.prototype,_),S=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.initialize=function(t){var e;return this.collection=new i.Collection(function(){var t,n,i,r;for(i=this.$el.data("existing"),r=[],t=0,n=i.length;n>t;t++)e=i[t],r.push(new d(e));return r}.call(this)),n.__super__.initialize.call(this,r.extend({container:this.$(".js-association-container")},t)),this.initializeInput()},n}(o.UserField),r.extend(S.prototype,_),T=function(n){function i(){return i.__super__.constructor.apply(this,arguments)}return t(i,n),i.prototype.removeSubView=function(t){return this.stopListening(t),t.remove()},i.prototype.renderTemplate=function(t,n){var i;return i={interpolate:/\{\{(.+?)\}\}/g,evaluate:/\{\-(.+?)\-\}/g,escape:/\{\{\-(.+?)\-\}\}/g},r.template(e(t).html(),n,i)},i}(i.View),p=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.events={"click .js-add":"add","click .js-cancel":"cancel"},n.prototype.add=function(){return this.$(".js-add").hasClass("c-button--loading")?void 0:(this.$(".js-add").addClass("c-button--loading"),this.$(".js-cancel").addClass("c-button--disabled"),this.trigger("add"))},n.prototype.cancel=function(){return this.reset(),this.trigger("cancel")},n.prototype.reset=function(){return this.$(".js-add").removeClass("c-button--loading"),this.$(".js-cancel").removeClass("c-button--disabled")},n}(i.View),f=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.initialize=function(){return this.controlGroup=new p({el:this.$(".js-add-cancel-group")}),this.listenTo(this.controlGroup,"cancel",function(t){return function(){return t.trigger("cancel")}}(this)),this.listenTo(this.controlGroup,"add",function(t){return function(){return t.add()}}(this))},n.prototype.add=function(){var t;return t=this.create(),t.isValid()?void 0:this.showErrors(t.validationError)},n.prototype.create=function(){return this.collection.create(this.attributes())},n.prototype.showErrors=function(t){return this.show({clear:!1}),this.$(".js-errors").show().html(t.join("<br>"))},n.prototype.show=function(t){var e,n;return n=r.extend({focus:!0,clear:!0},t||{}),this.controlGroup.reset(),this.$el.show(),e=this.$("input[type='text'],select,textarea").not("[name='user_id']"),n.clear&&e.val(""),n.focus&&e.filter(":visible").first().focus(),this.$(".js-errors").hide()},n.prototype.attributes=function(){var t,e,n,i,r;for(t={},r=this.fields,n=0,i=r.length;i>n;n++)e=r[n],t[e]=this.$("[name='"+e+"']").val();return t},n}(i.View),C=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.events={"click .js-add-new-tagging":"showNewTaggingView"},n.prototype.initialize=function(){return this.collection=new this.collectionClass,this.listenTo(this.collection,"reset",function(t){return function(){return t.collectionReset()}}(this)),this.listenTo(this.collection,"remove",function(t){return function(e){return t.collectionRemove(e)}}(this)),this.collection.reset(this.$el.data("taggings")),this.addNewTaggingView=new this.newTaggingViewClass({el:this.$(".js-new-form"),collection:this.collection}),this.listenTo(this.addNewTaggingView,"cancel",function(t){return function(){return t.hideTaggingView()}}(this))},n.prototype.collectionRemove=function(t){var e;return(e=r.find(this.rowViews,function(e){return e.model.id===t.id}))?(this.removeSubView(e),this.rowViews.splice(r.indexOf(this.rowViews,e),1)):void 0},n.prototype.collectionReset=function(){var t,e,n,i,o,a,s,l,u,c;if(!r.isEmpty(this.rowViews))for(s=this.rowViews,e=0,i=s.length;i>e;e++)c=s[e],c.remove();for(this.rowViews=[],t=this.$(".js-list-container"),l=this.collection.models,u=[],n=0,o=l.length;o>n;n++)a=l[n],c=new this.rowViewClass({model:a}),this.rowViews.push(c),u.push(t.append(c.el));return u},n.prototype.showNewTaggingView=function(t){return this.$(".js-add-new-tagging").hide(),this.addNewTaggingView.show(t)},n.prototype.hideTaggingView=function(){return this.$(".js-add-new-tagging").show(),this.addNewTaggingView.$el.hide()},n}(T),y=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.collectionReset=function(){var t,e,i,r;for(n.__super__.collectionReset.apply(this,arguments),i=this.rowViews,t=0,e=i.length;e>t;t++)r=i[t],this.listenTo(r,"edit",function(t){return function(e){return t.editTagging(e)}}(this));return this.addNewTaggingView?this.isEditing?this.hideTaggingView():this.showNewTaggingView():void 0},n.prototype.editTagging=function(t){return this.isEditing=!0,this.$(".js-add-new-tagging").hide(),this.addNewTaggingView.edit(t)},n.prototype.hideTaggingView=function(){return this.isEditing=!1,n.__super__.hideTaggingView.apply(this,arguments)},n}(C),k=function(i){function r(){return this.save_tagging=n(this.save_tagging,this),r.__super__.constructor.apply(this,arguments)}return t(r,i),r.prototype.save_tagging=function(t){return e.ajax({url:this.createURL,type:"post",data:t.attributes,success:function(t){return function(e){return t.reset(e.taggings)}}(this)})},r.prototype.create=function(t){var n;return n=new this.model(t),n.isValid()&&(e.isFunction(n.createPopover)?e.when(n.createPopover(this.save_tagging)).then(function(t){return function(e){return e.proceed?t.save_tagging(n):void 0}}(this)):this.save_tagging(n)),n},r}(i.Collection),A=function(i){function r(){return this.render=n(this.render,this),this.delete_tag=n(this.delete_tag,this),this.initialize=n(this.initialize,this),r.__super__.constructor.apply(this,arguments)}return t(r,i),r.prototype.initialize=function(){return this.$(".delete > a",this).removeAttr("onClick")},r.prototype.events={"click img.delete":"delete_tag"},r.prototype.delete_tag=function(t){return this.$el.css("opacity","0.7"),t.preventDefault(),this.model.isNew()?(this.model.destroy(),this.$el.fadeOut(function(t){return function(){return t.remove()}}(this))):this.model.destroy({wait:!0,success:function(t){return function(){return t.$el.fadeOut(function(){return t.remove()})}}(this)})},r.prototype.render=function(){var t;return t='<div data-tag_id="'+this.model.get("new_tag").id+'" class="new_taggings tag_edit">\n  <a href="'+this.model.get("new_tag").slug_url+'" target="_blank">'+this.model.get("new_tag").display_name+'</a>\n  <img class="delete" src="/images/tag-field/close-tag.png" title="Remove"/>\n  </div>',this.$el=e(t).data("new_tagging",this.model.toJSON()),this.el=this.$el.get()[0],this.delegateEvents(),this},r}(i.View),m=function(n){function i(){return i.__super__.constructor.apply(this,arguments)}return t(i,n),i.prototype.urlRoot="/new_taggings",i.prototype.initialize=function(){return i.__super__.initialize.apply(this,arguments),this.id=r.compact([this.get("id"),this.get("meta_data_id")]).join(":")},i.prototype.createPopover=function(t){var n;return n="new_tags/create_popover",e.ajax({url:"/"+n,data:{name:this.get("name"),tag_type:"CollegeTag"},success:function(i){return function(r){var o;return r.proceed||(o=e(r.create_popover_html),e.facybox(o),setTimeout(function(){return a["with"](e(a.selector(n)),function(e){return e.set({model:i,callback:t})})},100)),r}}(this)})},i.prototype.sync=function(t,n,r){var o;return"delete"===t&&(o=n.get("meta_data_id"))&&(r||(r={}),r.url="/new_taggings/remove_college_meta_data/"+o,r.contentType="application/json"),"update"===t&&(o=n.get("meta_data_id"))&&(r||(r={}),r.url="/new_taggings/"+o+"/update_college"),"update"!==t||r.hideCreatePopover?i.__super__.sync.call(this,t,n,r):e.when(n.createPopover()).then(function(e){return function(o){return o.proceed?i.__super__.sync.call(e,t,n,r):void 0}}(this))},i}(i.Model),v=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.model=m,n.prototype.createURL="/new_taggings/add_college",n}(k),g=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.className="college-row-view",n.prototype.events=function(){return{"click .js-edit":function(t){return function(){return t.trigger("edit",t.model)}}(this),"click .js-delete":function(t){return function(){return t.model.destroy()}}(this)}},n.prototype.initialize=function(){return this.render()},n.prototype.metaData=function(){var t,e,n,i,o;return n=[this.model.get("major"),this.model.get("degree"),this.model.get("year")],e=n[0],t=n[1],o=n[2],i="",(t||e)&&(i="&middot; "),i+=r.compact([t,e]).join(", "),o&&(i+=" "+o),i},n.prototype.render=function(){var t;return t=r.extend(this.model.toJSON(),{meta_data:this.metaData()}),this.$el.html(this.renderTemplate("#college-row-template",t))},n}(T),h=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.fields=["name","major","degree","year","description","meta_data_id","user_id"],n.prototype.initialize=function(){var t;return n.__super__.initialize.apply(this,arguments),t=new s.TagAutocomplete({el:this.$("input[name='name']"),tag_type:"CollegeTag"}),this.listenTo(t,"select",function(t){return function(e){return t.$("input[name='name']").attr("value",e.tag.display_name),t.$("input[name='major']").focus()}}(this))},n.prototype.add=function(){var t,e;if(this.$("input, a").blur(),null!=(e=this.attributes().meta_data_id)?e.length:void 0)t=this.update();else if(t=this.create(),t.isValid())return;return t.validationError?this.showErrors(t.validationError):void 0},n.prototype.update=function(){var t;return t=this.collection.find(function(t){return function(e){return parseInt(e.get("meta_data_id"))===parseInt(t.attributes().meta_data_id)}}(this)),t.save(this.attributes(),{success:function(t){return function(e,n){return t.collection.reset(n.taggings)}}(this)}),t},n.prototype.edit=function(t){var e,n,i,r;for(r=this.fields,n=0,i=r.length;i>n;n++)e=r[n],"user_id"!==e&&this.$("[name='"+e+"']").attr("value",t.get(e)||"");return this.show({clear:!1})},n}(f),{LimitAssociationMixin:_,NewTagField:b,NewTaggingField:w,StartupField:x,UserField:S,View:T,TaggingView:A,TaggingList:C,TaggingCollection:k,AddTaggingView:f,EditableTaggingList:y,CollegeTagging:m,CollegeTaggingCollection:v,CollegeRow:g,AddEditCollegeTaggingView:h}})}).call(this);