(function(){var t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t},e={}.hasOwnProperty,n=function(t,e){return function(){return t.apply(e,arguments)}},i=[].slice;define(["load","jquery","underscore","backbone","lib/elements","lib/form","lib/transitional_autocomplete","lib/extended_associations","lib/mentions","mixpanel","google/analytics","segment/analytics","controllers/user_graph_edges","models/user","jquery.magnific"],function(e,r,o,a,s,l,u,c,d,h,p,f,g,m){return{"new":function(t,e){return t(".cancel").on("click",function(){var t;return null!=(t=r.magnificPopup.instance)?t.close():void 0}),t(".js-submit").on("click",function(){return t(".js-submit").val("Sending..."),f.track("Message.MessageSent",{source:e.data("source")})})},form:function(t){return new d.Autocomplete({el:t(".body_container"),target:t(":input.body_hidden")}),t("textarea.body").focus()},compose:function(t){return t(".embedded_message textarea").focus()},inbox_compose:function(e,s){var l,d,h;return d=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.request_options=function(t){return{url:"/autocomplete/connections",data:{query:t},dataType:"json",type:"get"}},n.prototype.process_response=function(t,e){var i,r,a;return a=o.uniq(t.results,!1,function(t){return t.id}),t.results=a,i=n.__super__.process_response.call(this,t,e),i.length>0?i:(r=o.template("<a href='/social'>\n  <div class=\"u-fontSize13 u-textAlignCenter u-block s-vgPadTop0_5 s-vgPadBottom0_5 s-vgPadLeft1 s-vgPadRight1\">\n    You can only message direct connections. Add connections &raquo;\n  </div>\n</a>"),i.push({label:r,value:{}}),i)},n}(u.TypedAutocomplete),h=function(e){function a(){return this._select=n(this._select,this),a.__super__.constructor.apply(this,arguments)}return t(a,e),a.prototype.initialize=function(t){var e;return this.associationTemplate=t.associationTemplate,this.unverifiedEdgeLookup=this.$el.data("unverified_edge_lookup"),a.__super__.initialize.apply(this,arguments),this.$el.data("default_user")?(e=new m(this.$el.data("default_user")),this.addAssociation(e)):void 0},a.prototype.initializeAutocomplete=function(){return new d({el:this.input(),types:["User"]})},a.prototype.removeAssociation=function(){return a.__super__.removeAssociation.apply(this,arguments),r(this.input()).val(""),this.trigger("disableMessageButton")},a.prototype._select=function(){var t,e;return t=1<=arguments.length?i.call(arguments,0):[],e=this.associationFromSelect.apply(this,t),e.get("id")?(this.addAssociation(e),r(this.input()).val(""),!0):void 0},a.prototype.renderAssociation=function(t){var e;if(t.get("id"))return this.verifyEdge(t.get("id")),this.trigger("hideMessageHint"),e={name:t.get("display_name"),url:t.get("slug_url"),photo:t.get("pic"),allowDelete:this.isEditable()},o.template(this.associationTemplate.trim(),e,{interpolate:/\{\{(.+?)\}\}/g})},a.prototype.verifyEdge=function(t){var e;return(e=this.unverifiedEdgeLookup[t])?(r.magnificPopup.open({closeOnBgClick:!1,showCloseBtn:!1,enableEscapeKey:!1,items:{src:"/user_graph_edges/"+e+"?source=inbox_message_button"},type:"ajax"}),g.events().on("close_graph_modal",function(e){return function(n){return n.connected?(e.trigger("enableMessageButton"),delete e.unverifiedEdgeLookup[t]):e.$(".destroy").click()}}(this))):this.trigger("enableMessageButton")},a}(c.UserField),new(l=function(e){function i(){return this._bindListeners=n(this._bindListeners,this),i.__super__.constructor.apply(this,arguments)}return t(i,e),i.prototype.initialize=function(){return this._initializeUserField(),f.track("Messages.ViewedComposeNew")},i.prototype._initializeUserField=function(){var t;if((t=this.$(".js-user-tagger")).length>0)return this.userField=new h({el:t,associationTemplate:this.$(".js-user-template").html()}),this._bindListeners(),this.userField.associations().length>0?this.userField.trigger("enableMessageButton"):void 0},i.prototype._bindListeners=function(){return this.listenTo(this.userField,"enableMessageButton",function(t){return function(){return t.$(".js-send-message").removeClass("c-button--disabled disabled"),t.$(".js-compose-input").focus()}}(this)),this.listenTo(this.userField,"disableMessageButton",function(t){return function(){return t.$(".js-send-message").addClass("c-button--disabled disabled"),t.$(".js-message-hint").show()}}(this)),this.listenTo(this.userField,"hideMessageHint",function(t){return function(){return t.$(".js-message-hint").hide()}}(this))},i}(a.View))({el:s})},show:function(){return p.push(["_trackPageview","/PV/messages/viewed_one_message"])},index:function(t){return t(".thread").on("click",function(t){var e;if(!r(t.target).hasClass("unverified-thread"))return r(t.target).is("a, .photo, img")?void 0:(e=r(this).find(".preview > a").attr("href"),t.ctrlKey||t.metaKey?window.open(e,"_blank"):window.location=e)}),t(".js-edit-connection").click(function(t){return r.magnificPopup.open({closeOnBgClick:!1,showCloseBtn:!1,enableEscapeKey:!1,items:{src:r(t.currentTarget).data("url")},type:"ajax"})}),t(".js-add-connection").click(function(){var e,n;return e=t(this).data("invited-id"),n=t(this).data("url"),r.ajax({url:n,type:"POST",data:{invited_id:e},success:function(){return function(t){return f.track("UserGraph.Request",{source:"Messages",neighbor_id:e}),r.magnificPopup.open({closeOnBgClick:!1,showCloseBtn:!1,enableEscapeKey:!1,items:{src:"/user_graph_edges/"+t.edge_id+"?post_request=true&source=messages&request_id="+t.request_id},type:"ajax"})}}(this),error:function(t){return flash(t.responseJSON.error?t.responseJSON.error:"An error occurred, please try reloading the page.")}})}),g.events().on("close_graph_modal",function(e){var n;if(e.connected)return n=t(".unverified-container[data-neighbor_id="+e.neighbor_id+"]"),n.find(".verify-connection").hide(),n.find(".unverified-preview").show(),n.parents(".thread").removeClass("unverified-thread")})},profile_message:function(t){return e(["jquery.livestamp"],function(){return function(){return t(".date").livestamp(t(".date").data("timestamp"))}}(this))},profile:function(t){return t("> .more_link").on("click",function(){return t(this).hide(),t("> .message.hidden").show()}),t(".body_mentions").each(function(){return new d.Autocomplete({el:this,target:t(".body_target")})}),t(".new_message").each(function(){return t("textarea",this).focus(function(e){return function(){return t(".submit",e).show()}}(this)),t(this).ajaxForm(l.loadingOptions(this,{dataType:"json",success:function(e){return r("<div/>").addClass("message").insertBefore(t(".new_message")).append(r(e.html)),t(".new_message textarea").val("")}}))}),t(".canned_link").click(function(){return t(this).addClass("loading"),r.get(t(this).attr("href"),{},function(e){return function(n){return t(e).removeClass("loading"),t(".new_message textarea").focus().val(n.msg_body).trigger("change").trigger("autosize.resize")}}(this)),!1})},send_feedback:function(t){return t("textarea").focus(),t("form").submit(function(){return t(".g-button").addClass("loading"),r(this).ajaxSubmit({success:function(){return function(){return t(".close").click()}}(this)}),!1})},intro_request:function(t){return f.track("IntroRequest.ShowIntroRequestMessage",{source:"Messages"}),t(".js-refer").click(function(t){return f.track("IntroRequest.ShowReferralForm",{source:"Messages"}),r.magnificPopup.open({items:{src:r(t.currentTarget).data("url")},type:"ajax"})})},referral:function(t){return f.track("IntroRequest.ShowReferralMessage",{source:"Messages"}),t(".js-view-candidate").click(function(){return f.track("IntroRequest.TargetViewedCandidate",{source:"Messages"})})}}})}).call(this);